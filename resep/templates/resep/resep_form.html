{% extends "base.html" %}
{% block content %}
       
<section class="section">
    <div class="section-header">
        <h1>Tambah Resep Baru</h1>
    </div>
</section>

<section class="section">
    <div class="section-body">
        <form method="post" action="{% url 'resep_create' %}">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4></h4>
                            <div class="card-header-action">
                                <button class='btn btn-primary' type="submit">Simpan Resep</button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% csrf_token %}
                            
                            
                            <div class="form-group">
                                <label for="id_kode_bahan">Nama</label>
                                <input class="form-control" name="nama_roti" type="text" placeholder='Masukan Nama Roti'>    
                            </div>
                            
                            
                            <div class="form-group">
                                <label for="id_kode_bahan">Kode Resep</label>
                                <input class="form-control" name="kode_barang" type="text" placeholder='Masukan kode barang'>    
                            </div>
                            
                            <div class="form-group">
                                <label for="id_kode_bahan">Harga Jual</label>
                                <input data-nama-bantuan="harga-bantuan-rupiah" class="form-control bantuan-rupiah" name="harga_jual" type="text" placeholder='Masukan Harga'>
                                <span id="harga-bantuan-rupiah" class="text-small">.</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_kode_bahan">HPP</label>
                                <input id="hpp" class="form-control" name="hpp" type="text" readonly>
                            </div>
                            
                            {% comment %} line {% endcomment %}
                            <hr>
                            
                            
                            <div class="form-group">
                                <label for="id_kode_bahan">Bahan Tersedia</label>
                                <select id="bahans" class="js-example-basic-single form-control" name="bahan_list[]">
                                    {% for bahan in bahans %}
                                    <option value="{{ bahan.id }}" data-kode="{{ bahan.kode_bahan }}"> {{ bahan.nama }}</option>
                                    {% endfor %}
                                </select>
                                <div onclick="add_bahan()" style="margin-top: 25px" class='btn btn-info'>+</div>
                                
                            </div>                            
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    
                    
                    {% csrf_token %}
                    <div id="data_card">
                    </div>
                    
                    
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock content %}
            
{% block script %}
<script>
    $(document).ready(function() {
        $('.js-example-basic-single').select2();
    });
</script>
<script>
    function get_data_bahan(id) {
        var url = 'http://localhost:8001/resep/cek_bahan/' + id + '/';
        // Menggunakan fetch untuk mengambil data
        return fetch(url)
        .then(function(response) {
            // Mengubah respons menjadi JSON
            return response.json();
        })
        .then(function(bahan) {
            // Memastikan objek bahan memiliki struktur yang benar
            let satuan = "gram";
            let harga_persatuan = bahan['harga_gram'];
            
            var e = document.getElementById("bahans");
            var value = e.value;
            var nama_bahan = e.options[e.selectedIndex].text;
            // Mengembalikan objek yang berisi data relevan
            console.log(url)
            return {
                nama_bahan: nama_bahan,
                kode_bahan: bahan.kode_bahan,
                satuan: satuan,
                harga_persatuan: harga_persatuan
            };
        })
        .catch(function(err) {
            console.log('Kesalahan Fetch :-S', err);
        });
    }
    
    function remove_bahan(id) {
        $("#data_bahan" + id).remove();
        cekhpp();
    }        
    
    function cekhpp(){
        let all_bahan = []
        let hpp_sum = 0;
        $('.bahan_added').each(function() {
            var id_current = $(this).attr('id');
            var kode_bahan = id_current.split('#')[1];
            var value = $(this).val();
            var hargapersatuan = $(this).data('hargapersatuan');
            var hpp_satuan = value * hargapersatuan;
    
            // Update the span element with the calculated HPP
            console.log()
            $('#hpp_satuan-' + kode_bahan).text(convertToTitikFormat(hpp_satuan.toString()));
    
            // Calculate total HPP
            hpp_sum += hpp_satuan;
        });
    
        // Display the total HPP
        $('#hpp').val(convertToTitikFormat(hpp_sum.toString()));
    }
    
    
    function add_bahan() {
        var value = $("#bahans").val();
        var nama_bahan = $("#bahans option:selected").text();
        var kode_bahan = $("#bahans option:selected").data('kode');
        // Panggil get_data_bahan dan tangani Promise yang dikembalikan
        // Panggil get_data_bahan dan tangani Promise yang dikembalikan
        get_data_bahan(value)
        .then(function(bahanData) {
            var html = `<div class="card card-warning" id='data_bahan${value}'>
                <div class="card-header">
                    <h4>${bahanData.nama_bahan || ''}</h4>
                    <div class="card-header-action">
                        <div onclick='remove_bahan("${value}")' class='btn btn-danger hapus-bahan' id='hapus-bahan-${value}'>x</div>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" >
                        <li class="list-group-item" style="padding:0">Nama Bahan : ${bahanData.nama_bahan || ''} </li>
                        <li class="list-group-item" style="padding:0">Kode Bahan : ${bahanData.kode_bahan || ''} </li>
                        <li class="list-group-item" style="padding:0">Satuan : <b>${bahanData.satuan || ''}</b></li>
                        <li class="list-group-item" style="padding:0">Harga Jual: <span id='hpp_satuan-${bahanData.kode_bahan}'></span></li>
                        <li class="list-group-item" style="padding:0">Harga Jumlah pakai : 
                            <input id='bahan_added#${bahanData.kode_bahan}' onkeyup='cekhpp()'  class='form-control bahan_added' data-hargapersatuan='${bahanData.harga_persatuan}' name='jumlah_satuan[]' type='number' placeholder='Masukkan Jumlah Satuan Pakai'>
                            <input class='form-control' style='visibility: hidden' name='id_bahan[]' type='number' value='${value}'>
                        </li>
                        <li class="list-group-item" style="padding:0"><div id='jumlah-bahan-container-${value}'></div></li>
                    </ul>
                </div>
            </div>`;
            
            // Sisipkan HTML ke elemen yang ditentukan
            $("#data_card").append(html);
        });
    }
    
    function get_data_master(id) {
        var url = 'http://localhost:8001/resep/cek_master/' + id + '/';
        // Menggunakan fetch untuk mengambil data
        return fetch(url)
        .then(function(response) {
            // Mengubah respons menjadi JSON
            return response.json();
        })
        .then(function(master) {
            // Memastikan objek master memiliki struktur yang benar
            
            var e = document.getElementById("masters");
            var value = e.value;
            var nama_master = e.options[e.selectedIndex].text;
            
            // Mengembalikan objek yang berisi data relevan
            return {
                nama: nama_master,
                kode_master: master.kode_barang // tambahkan kode_master dari respons server
            };
        })
        .catch(function(err) {
            console.log('Kesalahan Fetch :-S', err);
        });
    }
    
    
    function remove_master(id) {
        $("#data_master" + id).remove();
    }
    
    function add_master() {
        var value = $("#masters").val();
        var nama_master = $("#masters option:selected").text();
        var kode_master = $("#masters option:selected").data('kode');
    
        // Panggil get_data_master dan tangani Promise yang dikembalikan
        get_data_master(value)
            .then(function(masterData) {
                var html = `
                    <div class='card' id='data_master${value}'>
                        <div class='card-body'>
                            Nama:<b>${masterData.nama || ''}</b><br>
                            Kode:<b>${kode_master || ''}</b><br>
                            <div id='jumlah-master-container-${value}'></div>
                            <div class='btn btn-danger hapus-master' id='hapus-master-${value}'>Hapus master</div>
                        </div>
                    </div>`;
                // Sisipkan HTML ke elemen yang ditentukan
                $("#data_card").append(html);
            });
    }        
            
</script>
{% endblock script %}